<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.sadowbass.outerpark.infra.mapper.ProductRepositoryMapper">
    <select id="findProductInfoByProductId" parameterType="long">
        SELECT p.id             AS id,
               h.name           AS hall_name,
               MIN(r.date_time) AS first_date,
               MAX(r.date_time) AS last_date,
               p.name           AS name,
               p.`describe`     AS `describe`,
               p.running_time   AS running_time
        FROM PRODUCTS p
                 JOIN HALL h ON p.hall_id = h.id
                 JOIN ROUNDS r ON r.product_id = p.id
        WHERE p.id = #{productId}
        GROUP BY p.id, h.name, p.name, p.`describe`, p.running_time
    </select>

    <resultMap id="roundInfos" type="RoundInfo">
        <id property="id" column="round_id"/>
        <result property="dateTime" column="date_time"/>
        <collection property="gradeRemains" ofType="GradeRemain">
            <result property="id" column="grade_id"/>
            <result property="name" column="grade_name"/>
            <result property="remain" column="remain"/>
        </collection>
    </resultMap>

    <select id="findRoundInfosByProductId" parameterType="long" resultMap="roundInfos">
        SELECT r.id                                AS round_id,
               r.date_time                         AS date_time,
               g.id                                AS grade_id,
               g.name                              AS grade_name,
               SUM(IF(rs.status = 'enable', 1, 0)) AS remain
        FROM ROUNDS r
                 JOIN ROUND_SEATS rs ON rs.round_id = r.id
                 JOIN GRADES g ON g.id = rs.grade_id
        WHERE r.product_id = #{productId}
        GROUP BY r.id, r.date_time, g.id, g.name
    </select>

    <select id="findAvailableSeatByRoundIdAndGradeId" resultType="AvailableSeat">
        SELECT g.id,
               s.name AS seat_name
        FROM ROUND_SEATS rs
                 JOIN SEATS s ON s.id = rs.seat_id
                 JOIN ROUNDS r ON r.id = rs.round_id AND r.id = #{roundId}
                 JOIN GRADES g ON g.id = rs.grade_id AND g.id = #{gradeId}
        WHERE rs.status = 'ENABLE';
    </select>

    <select id="findEnabledRoundSeatsByRoundIdAndSeatIds" resultType="RoundSeats">
        SELECT *
        FROM ROUND_SEATS
        WHERE round_id = #{roundId}
        AND seat_id IN
        <foreach collection="seats" item="seatId" separator="," open="(" close=")">
            #{seatId}
        </foreach>
        AND status = 'enable'
        FOR
        UPDATE NOWAIT
    </select>

    <update id="pendingRoundSeats">
        <foreach collection="seats" item="seat" separator=";">
            UPDATE ROUND_SEATS
            SET
            member_id = #{seat.memberId},
            status = #{seat.status},
            expire = #{seat.expire},
            modified_by = #{seat.modifiedBy},
            modified_date = #{seat.modifiedDate},
            pending_id = #{seat.pendingId}
            WHERE id = #{seat.id}
        </foreach>
    </update>

    <select id="findPendingRoundSeats" resultType="RoundSeats">
        SELECT *
        FROM ROUND_SEATS
        WHERE member_id = #{memberId}
          AND round_id = #{roundId}
          AND pending_id = #{pendingId}
    </select>

    <update id="reserveRoundSeats">
        UPDATE ROUND_SEATS
        SET status = 'RESERVED',
        modified_date = now(),
        modified_by = #{memberId}
        WHERE id IN
        <foreach collection="seats" item="seatId" separator="," open="(" close=")">
            #{seatId}
        </foreach>
    </update>

    <insert id="createTickets">
        INSERT INTO TICKETS(
        member_id,
        round_seat_id,
        product_name,
        hall_name,
        round_date_time,
        seat_name,
        grade_name,
        price,
        created_date,
        created_by,
        modified_date,
        modified_by
        )
        SELECT #{memberId} AS member_id,
        rs.id AS round_seat_id,
        p.name AS product_name,
        h.name AS hall_name,
        r.date_time AS round_date_time,
        s.name AS seat_name,
        g.name AS grade_name,
        g.price AS price,
        NOW() AS created_date,
        #{memberId} AS created_by,
        NOW() AS modified_date,
        NULL AS modified_by
        FROM ROUND_SEATS rs
        JOIN GRADES g ON g.id = rs.grade_id
        JOIN ROUNDS r ON r.id = rs.round_id
        JOIN SEATS s ON s.id = rs.seat_id
        JOIN PRODUCTS p ON p.id = r.product_id
        JOIN HALL h ON h.id = p.hall_id
        WHERE rs.id IN
        <foreach collection="seats" item="seatId" separator="," open="(" close=")">
            #{seatId}
        </foreach>
        AND r.id = #{roundId}
    </insert>
</mapper>